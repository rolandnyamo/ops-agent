AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: App resources (Lambdas, API, roles, env)

Parameters:
  ProjectName: { Type: String, Default: ops-agent }
  Stage: { Type: String, Default: prod }
  EnableAuth:
    Type: String
    Default: 'true'
    AllowedValues: ['true','false']
    Description: Toggle API authorizers (set to 'false' for local SAM testing)
  VectorBucketName:
    Type: String
    Default: ops-embeddings
    Description: Name of the S3 Vectors bucket (created manually)
  RawBucketName:
    Type: String
    Default: ops-agent-prod-raw-326445141506-us-east-1
    Description: Name of the S3 Raw bucket (created manually)
  VectorIndexName:
    Type: String
    Default: docs
    Description: S3 Vectors index name
  SesSenderEmail:
    Type: String
    Default: roland@rolandn.dev
    Description: Verified SES email identity used for job notifications

Globals:
  Function:
    Runtime: nodejs22.x
    Architectures:
      - arm64
    MemorySize: 512
    Timeout: 30
    Tracing: Active
    Environment:
      Variables:
        COGNITO_USER_POOL_ID: !Ref UserPool
        COGNITO_USER_POOL_CLIENT_ID: !Ref UserPoolClient
        DOCS_TABLE: 'ops-agent-prod-docs'  # This will be overridden by the actual import value in the function definition
        SETTINGS_TABLE: 'ops-agent-prod-settings'  # This will be overridden by the actual import value in the function definition
        RAW_BUCKET: 'ops-agent-prod-raw-326445141506-us-east-1'  # This will be overridden by the actual import value in the function definition
        VECTOR_BUCKET: 'ops-embeddings'  # This will be overridden by the actual import value in the function definition
        VECTOR_INDEX: 'docs'  # This will be overridden by the actual import value in the function definition
        VECTOR_MODE: s3vectors
        VECTOR_DIMENSION: '1536'
        TRANSLATION_PROVIDER: openai
        TRANSLATION_MODEL: gpt-4o-mini
        SES_SENDER: !Ref SesSenderEmail

Resources:
  Api:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref Stage
      Cors:
        AllowOrigin: "'*'"
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'authorization,content-type,access-control-allow-origin,x-bot-signature,x-bot-timestamp,x-bot-api-key'"
      Auth:
        Authorizers:
          AdminCognitoAuth:
            UserPoolArn: !GetAtt UserPool.Arn
            # JwtConfiguration:
            #   issuer: !Sub "https://cognito-idp.${AWS::Region}.amazonaws.com/${UserPool}"
            #   audience:
            #     - !Ref UserPoolClient
            # IdentitySource: "$request.header.Authorization"
          BotLambdaAuth:
            FunctionPayloadType: REQUEST
            FunctionArn: !GetAtt BotAuthFn.Arn
            FunctionInvokeRole: !GetAtt BotAuthApiInvokeRole.Arn
            AuthorizerPayloadFormatVersion: 2.0
            Identity:
              Headers:
                - X-Bot-API-Key
        DefaultAuthorizer: AdminCognitoAuth
        AddDefaultAuthorizerToCorsPreflight: false
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub "${ProjectName}-${Stage}-admin"
      UsernameAttributes: [email]
      AutoVerifiedAttributes: [email]
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
          RequireUppercase: true
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref UserPool
      ClientName: admin-ui
      GenerateSecret: false
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthFlows: [code]
      AllowedOAuthScopes: [openid, email, profile]
      CallbackURLs: ["http://localhost:3000"]
      LogoutURLs: ["http://localhost:3000"]
      SupportedIdentityProviders: [COGNITO]

  AdminGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: admin
      Description: Administrators with full access to user management
      UserPoolId: !Ref UserPool
      Precedence: 10

  BotAuthFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Stage}-bot-auth"
      CodeUri: ../src
      Handler: handlers/auth/botAuth.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:*
              Resource: "*"

  BotAuthApiInvokeRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - "apigateway.amazonaws.com"
                - "lambda.amazonaws.com"
            Action: "sts:AssumeRole"
      Policies:
        - PolicyName: LambdaAuthorizerInvokePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "lambda:InvokeFunction"
                Resource: !GetAtt BotAuthFn.Arn

  AskFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Stage}-ask"
      CodeUri: ../src
      Handler: handlers/ask.handler
      Events:
        PostQA:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /qa
            Method: POST
        PostAsk:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /ask
            Method: POST
            Auth:
              Authorizer: BotLambdaAuth
      Environment:
        Variables:
          var1: value1
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:*
              Resource:
                - !ImportValue { 'Fn::Sub': '${ProjectName}-${Stage}-DocsTableArn' }
                - !ImportValue { 'Fn::Sub': '${ProjectName}-${Stage}-SettingsTableArn' }
        - S3ReadPolicy:
            BucketName: '*'
        - Statement:
            - Effect: Allow
              Action:
                - s3:*
                - s3vectors:*
              Resource:
                - "*"
        - Statement:
            - Effect: Allow
              Action:
                - s3vectors:*
              Resource:
                - "*"
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/openai/key"

  IngestionFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Stage}-ingestion"
      CodeUri: ../src
      Handler: handlers/docs.handler
      Events:
        PostIngest:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /docs/ingest
            Method: POST
      Environment:
        Variables:
          var1: value1
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:*
              Resource: "*"
        - S3WritePolicy:
            BucketName: "*"

  UploadUrlFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Stage}-upload-url"
      CodeUri: ../src
      Handler: handlers/uploadUrl.handler
      Events:
        PostUploadUrl:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /docs/upload-url
            Method: POST
      Environment:
        Variables:
          var1: value1
      Policies:
        - S3WritePolicy:
            BucketName: "*"

  IngestionWorkerFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Stage}-ingest-worker"
      CodeUri: ../src
      Handler: handlers/ingestWorker.handler
      Timeout: 180
      MemorySize: 1024
      Environment:
        Variables:
          ENABLE_TERM_STATS: 'true'
          SETTINGS_TABLE: !ImportValue { 'Fn::Sub': '${ProjectName}-${Stage}-SettingsTableName' }
          SES_SENDER: !Ref SesSenderEmail
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:*
              Resource: '*'
        - S3ReadPolicy:
            BucketName: '*'
        - S3WritePolicy:
            BucketName: '*'
        - Statement:
            - Effect: Allow
              Action:
                - s3:PutObject
                - s3:DeleteObject
                - s3:ListBucket
                - s3vectors:PutVectors
                - s3vectors:CreateIndex
              Resource:
                - "*"
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/openai/key"
        - Statement:
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource:
                - "*"
        - Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendRawEmail
              Resource: '*'

  S3PutRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub "${ProjectName}-${Stage}-raw-objectcreated"
      EventPattern:
        source: ["aws.s3"]
        detail-type: ["Object Created"]
        detail:
          bucket:
            name: [ !Ref RawBucketName ]
          object:
            key:
              - prefix: "raw/"
      Targets:
        - Arn: !GetAtt IngestionWorkerFn.Arn
          Id: IngestionWorkerFnTarget

  IngestionWorkerPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref IngestionWorkerFn
      Principal: events.amazonaws.com
      SourceArn: !GetAtt S3PutRule.Arn

  SynonymsGenFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Stage}-synonyms-gen"
      CodeUri: ../src
      Handler: handlers/synonymsGen.handler
      Timeout: 20
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:*
              Resource: "*"

  SynonymsEventRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub "${ProjectName}-${Stage}-synonyms-requested"
      EventPattern:
        source: ["ops-agent"]
        detail-type: ["SynonymsRequested"]
      Targets:
        - Arn: !GetAtt SynonymsGenFn.Arn
          Id: SynonymsGenTarget

  SynonymsGenPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref SynonymsGenFn
      Principal: events.amazonaws.com
      SourceArn: !GetAtt SynonymsEventRule.Arn

  DocsFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Stage}-docs"
      CodeUri: ../src
      Handler: handlers/docs.handler
      Environment:
        Variables:
          var1: value1
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:*
              Resource: "*"
        - S3CrudPolicy:
            BucketName: '*'
        - Statement:
            - Effect: Allow
              Action:
                - s3:*
              Resource:
                - "*"
        - Statement:
            - Effect: Allow
              Action:
                - s3vectors:DeleteVectors
              Resource:
                - "*"
      Events:
        ListDocs:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /docs
            Method: GET
            
        GetDoc:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /docs/{docId}
            Method: GET
            
        UpdateDoc:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /docs/{docId}
            Method: PUT
            
        DeleteDoc:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /docs/{docId}
            Method: DELETE

  TranslationsFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Stage}-translations"
      CodeUri: ../src
      Handler: handlers/translations.handler
      Environment:
        Variables:
          DOCS_TABLE: !ImportValue { 'Fn::Sub': '${ProjectName}-${Stage}-DocsTableName' }
          RAW_BUCKET: !ImportValue { 'Fn::Sub': '${ProjectName}-${Stage}-RawBucketName' }
          TRANSLATION_PROVIDER: openai
          TRANSLATION_MODEL: gpt-4o-mini
          SETTINGS_TABLE: !ImportValue { 'Fn::Sub': '${ProjectName}-${Stage}-SettingsTableName' }
          SES_SENDER: !Ref SesSenderEmail
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:*
              Resource: "*"
        - S3ReadPolicy:
            BucketName: '*'
        - S3WritePolicy:
            BucketName: '*'
        - Statement:
            - Effect: Allow
              Action:
                - s3:DeleteObject
              Resource: '*'
        - Statement:
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: '*'
        - Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendRawEmail
              Resource: '*'
      Events:
        PostTranslationUploadUrl:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /translations/upload-url
            Method: POST
        ListTranslations:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /translations
            Method: GET
        CreateTranslation:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /translations
            Method: POST
        GetTranslation:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /translations/{translationId}
            Method: GET
        UpdateTranslation:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /translations/{translationId}
            Method: PUT
        GetTranslationChunks:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /translations/{translationId}/chunks
            Method: GET
        UpdateTranslationChunks:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /translations/{translationId}/chunks
            Method: PUT
        ApproveTranslation:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /translations/{translationId}/approve
            Method: POST
        DownloadTranslation:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /translations/{translationId}/download
            Method: GET
        DeleteTranslation:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /translations/{translationId}
            Method: DELETE
        RestartTranslation:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /translations/{translationId}/restart
            Method: POST
        ListTranslationLogs:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /translations/{translationId}/logs
            Method: GET
        TranslationLogsOptions:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /translations/{translationId}/logs
            Method: OPTIONS

  TranslationWorkerFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Stage}-translation-worker"
      CodeUri: ../src
      Handler: handlers/translationWorker.handler
      Timeout: 180
      MemorySize: 1024
      Environment:
        Variables:
          DOCS_TABLE: !ImportValue { 'Fn::Sub': '${ProjectName}-${Stage}-DocsTableName' }
          RAW_BUCKET: !ImportValue { 'Fn::Sub': '${ProjectName}-${Stage}-RawBucketName' }
          TRANSLATION_PROVIDER: openai
          TRANSLATION_MODEL: gpt-4o-mini
          SETTINGS_TABLE: !ImportValue { 'Fn::Sub': '${ProjectName}-${Stage}-SettingsTableName' }
          SES_SENDER: !Ref SesSenderEmail
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:*
              Resource: '*'
        - Statement:
            - Effect: Allow
              Action:
                - s3:*
              Resource: '*'
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - "*"
        - S3ReadPolicy:
            BucketName: '*'
        - S3WritePolicy:
            BucketName: '*'
        - Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendRawEmail
              Resource: '*'

  TranslationEventRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub "${ProjectName}-${Stage}-translation-requested"
      EventPattern:
        source: ["ops-agent"]
        detail-type: ["TranslationRequested"]
      Targets:
        - Arn: !GetAtt TranslationWorkerFn.Arn
          Id: TranslationWorkerTarget

  TranslationWorkerPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref TranslationWorkerFn
      Principal: events.amazonaws.com
      SourceArn: !GetAtt TranslationEventRule.Arn

  JobHealthCheckFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Stage}-job-health"
      CodeUri: ../src
      Handler: handlers/jobHealthCheck.handler
      Timeout: 120
      Environment:
        Variables:
          DOCS_TABLE: !ImportValue { 'Fn::Sub': '${ProjectName}-${Stage}-DocsTableName' }
          RAW_BUCKET: !ImportValue { 'Fn::Sub': '${ProjectName}-${Stage}-RawBucketName' }
          SETTINGS_TABLE: !ImportValue { 'Fn::Sub': '${ProjectName}-${Stage}-SettingsTableName' }
          SES_SENDER: !Ref SesSenderEmail
          INGEST_WORKER_FUNCTION_NAME: !Sub "${ProjectName}-${Stage}-ingest-worker"
          JOB_HEALTH_STALE_MINUTES: '15'
          JOB_HEALTH_MAX_RETRIES: '3'
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:*
              Resource: '*'
        - Statement:
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: '*'
        - Statement:
            - Effect: Allow
              Action:
                - lambda:InvokeFunction
              Resource: !GetAtt IngestionWorkerFn.Arn
        - Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendRawEmail
              Resource: '*'
      Events:
        ScheduledCheck:
          Type: Schedule
          Properties:
            Schedule: rate(10 minutes)
            Name: !Sub "${ProjectName}-${Stage}-job-health"

  ViewDocFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Stage}-view-doc"
      CodeUri: ../src
      Handler: handlers/viewDoc.handler
      Timeout: 30
      Environment:
        Variables:
          var1: value1
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
              Resource:
                - !ImportValue { 'Fn::Sub': '${ProjectName}-${Stage}-DocsTableArn' }
        - Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:ListObjects
                - s3:ListObjectsV2
              Resource:
                - !Sub "arn:aws:s3:::${RawBucketName}/*"
      Events:
        ViewDoc:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /docs/view/{docId}
            Method: GET
            
  AgentsFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Stage}-agents"
      CodeUri: ../src
      Handler: handlers/agents.handler
      Environment:
        Variables:
          var1: value1
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:*
              Resource: "*"
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - "*"
        - Statement:
            - Effect: Allow
              Action:
                - s3vectors:CreateIndex
                - s3vectors:DeleteIndex
              Resource:
                - "*"
      Events:
        CreateAgent:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /agents
            Method: POST
        ListAgents:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /agents
            Method: GET
        GetAgent:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /agents/{agentId}
            Method: GET
        DeleteAgent:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /agents/{agentId}
            Method: DELETE
            
  BotsFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Stage}-bots"
      CodeUri: ../src
      Handler: handlers/bots.handler
      Environment:
        Variables:
          var1: value1
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:*
              Resource: "*"
      Events:
        CreateBot:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /agents/{agentId}/bots
            Method: POST
        ListBots:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /agents/{agentId}/bots
            Method: GET
        GetAllBots:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /bots
            Method: GET
        GetBot:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /agents/{agentId}/bots/{botId}
            Method: GET
        UpdateBot:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /agents/{agentId}/bots/{botId}
            Method: PUT
        DeleteBot:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /agents/{agentId}/bots/{botId}
            Method: DELETE
            
  InferFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Stage}-infer"
      CodeUri: ../src
      Handler: handlers/infer.handler
      Timeout: 20
      Environment:
        Variables:
           var1: value1
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/openai/key"
      Events:
        PostInfer:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /infer
            Method: POST

  SettingsFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Stage}-settings"
      CodeUri: ../src
      Handler: handlers/settings.handler
      Events:
        GetSettings:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /settings
            Method: GET
        PutSettings:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /settings
            Method: PUT
      Environment:
        Variables:
          var1: value1
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:*
              Resource: "*"

  UsersFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${Stage}-users"
      CodeUri: ../src
      Handler: handlers/users.handler
      Events:
        GetUsers:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /users
            Method: GET
        GetUser:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /users/{userId}
            Method: GET
        InviteUser:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /users/invite
            Method: POST
        ActivateUser:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /users/{userId}/activate
            Method: PUT
        DeactivateUser:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /users/{userId}/deactivate
            Method: PUT
        UpdateUserNotifications:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /users/{userId}/notifications
            Method: PUT
        UserNotificationsOptions:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /users/{userId}/notifications
            Method: OPTIONS
        DeleteUser:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /users/{userId}
            Method: DELETE

      Environment:
        Variables:
          COGNITO_USER_POOL_ID: !Ref UserPool
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - cognito-idp:ListUsers
                - cognito-idp:AdminCreateUser
                - cognito-idp:AdminDeleteUser
                - cognito-idp:AdminEnableUser
                - cognito-idp:AdminDisableUser
                - cognito-idp:AdminGetUser
                - cognito-idp:AdminListGroupsForUser
              Resource: !GetAtt UserPool.Arn
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:*
              Resource: "*"

Outputs:
  ApiEndpoint:
    Value: !Sub "https://${Api}.execute-api.${AWS::Region}.amazonaws.com/${Stage}"
  UserPoolId:
    Value: !Ref UserPool
  UserPoolClientId:
    Value: !Ref UserPoolClient
